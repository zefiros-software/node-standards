name: Typescript Package CI

on: push

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - uses: ./.github/actions/setup-node
      - run: npm run lint

  types:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - uses: ./.github/actions/setup-node
      - run: npm run check:types

  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - uses: ./.github/actions/setup-node
      - run: npm run check:coverage

  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - uses: ./.github/actions/setup-node
      - run: npm run build
      - name: Dist artifacts
        uses: actions/upload-artifact@v2
        with:
          name: node-standards
          path: |
            .main.js
            .main.js.map
            index.d.ts
            src/**/*.d.ts

  library:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Download node standards
        uses: actions/download-artifact@v2
        with:
          name: node-standards
      - uses: ./.github/actions/setup-node
        with:
          working-directory: examples/library/
          global-packages: yalc
          preinstall: yalc publish --script=false && cd examples/library && yalc add @zefiros-software/node-standards
      - run: npm run check:full
        working-directory: examples/library

  yargs:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Download node standards
        uses: actions/download-artifact@v2
        with:
          name: node-standards
      - uses: ./.github/actions/setup-node
        with:
          working-directory: examples/yargs-cli/
          global-packages: yalc
          preinstall: yalc publish --script=false && cd examples/yargs-cli && yalc add @zefiros-software/node-standards
      - run: npm run check:full
        working-directory: examples/yargs-cli

  release:
    needs: [library, yargs, check, test, types]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Download node standards
        uses: actions/download-artifact@v2
        with:
          name: node-standards
          path: .dist
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/release
        with:
          dry_run: ${{ github.ref == 'refs/heads/next' || github.ref == 'refs/heads/main' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.GITHUB_TOKEN }}
